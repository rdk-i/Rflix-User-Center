<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Countdown System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>üß™ Countdown System Test</h1>
  
  <div class="test-section">
    <h2>Test Countdown Calculation</h2>
    <button onclick="testCountdownCalculation()">Test Countdown Logic</button>
    <div id="countdownTestResult" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>Test API Endpoints</h2>
    <button onclick="testPackagesEndpoint()">Test Packages API</button>
    <button onclick="testRegistrationEndpoint()">Test Registration API</button>
    <div id="apiTestResult" class="result"></div>
  </div>
  
  <div class="test-section">
    <h2>Manual Countdown Examples</h2>
    <button onclick="showCountdownExamples()">Show Examples</button>
    <div id="examplesResult" class="result"></div>
  </div>

  <script>
    // Countdown calculation logic (same as in userController.js)
    function calculateCountdown(expirationDateStr) {
      const expiration = new Date(expirationDateStr);
      const now = new Date();
      const timeDiff = expiration - now;
      const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
      const isExpired = timeDiff < 0;
      
      let countdownText;
      if (isExpired) {
        countdownText = 'Expired';
      } else if (daysRemaining === 0) {
        countdownText = 'Expires Today';
      } else if (daysRemaining === 1) {
        countdownText = 'Expires Tomorrow';
      } else {
        countdownText = `Sisa ${daysRemaining} hari`;
      }
      
      return {
        daysRemaining,
        isExpired,
        countdownText,
        expirationDate: expirationDateStr
      };
    }
    
    function testCountdownCalculation() {
      const resultDiv = document.getElementById('countdownTestResult');
      resultDiv.innerHTML = '<h3>Countdown Calculation Test Results:</h3>';
      
      // Test cases
      const testCases = [
        {
          name: 'Future date (30 days)',
          date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
          name: 'Future date (1 day)',
          date: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
          name: 'Today',
          date: new Date().toISOString()
        },
        {
          name: 'Past date (expired)',
          date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
        }
      ];
      
      testCases.forEach(testCase => {
        const result = calculateCountdown(testCase.date);
        const status = result.isExpired ? 'error' : 'success';
        
        resultDiv.innerHTML += `
          <div class="${status}">
            <strong>${testCase.name}:</strong><br>
            Date: ${new Date(testCase.date).toLocaleDateString()}<br>
            Days Remaining: ${result.daysRemaining}<br>
            Countdown Text: ${result.countdownText}<br>
            Is Expired: ${result.isExpired}
          </div>
        `;
      });
      
      resultDiv.innerHTML += '<p class="success">‚úÖ Countdown calculation test completed!</p>';
    }
    
    async function testPackagesEndpoint() {
      const resultDiv = document.getElementById('apiTestResult');
      resultDiv.innerHTML = '<h3>Testing Packages API...</h3>';
      
      try {
        const response = await fetch('/api/packages');
        const data = await response.json();
        
        if (data.success) {
          resultDiv.innerHTML += `<p class="success">‚úÖ Packages API working!</p>`;
          resultDiv.innerHTML += `<p>Found ${data.data.length} packages:</p>`;
          data.data.forEach(pkg => {
            resultDiv.innerHTML += `<div class="info">
              - ${pkg.name}: ${pkg.duration_days} days, Rp ${pkg.price}
            </div>`;
          });
        } else {
          resultDiv.innerHTML += `<p class="error">‚ùå Packages API error: ${data.error?.message}</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML += `<p class="error">‚ùå Packages API failed: ${error.message}</p>`;
      }
    }
    
    async function testRegistrationEndpoint() {
      const resultDiv = document.getElementById('apiTestResult');
      resultDiv.innerHTML = '<h3>Testing Registration API...</h3>';
      
      // First get packages to get a valid packageId
      try {
        const packagesResponse = await fetch('/api/packages');
        const packagesData = await packagesResponse.json();
        
        if (packagesData.success && packagesData.data.length > 0) {
          const packageId = packagesData.data[0].id;
          resultDiv.innerHTML += `<p class="info">Using package ID: ${packageId}</p>`;
          
          // Test registration
          const registrationData = {
            username: 'testuser_' + Date.now(),
            email: 'test_' + Date.now() + '@example.com',
            password: 'password123',
            packageId: packageId
          };
          
          const regResponse = await fetch('/api/simple-registration/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(registrationData)
          });
          
          const regData = await regResponse.json();
          
          if (regData.success) {
            resultDiv.innerHTML += `<p class="success">‚úÖ Registration successful!</p>`;
            resultDiv.innerHTML += `<div class="info">
              User ID: ${regData.data.userId}<br>
              Package: ${regData.data.packageName}<br>
              Duration: ${regData.data.durationDays} days
            </div>`;
          } else {
            resultDiv.innerHTML += `<p class="error">‚ùå Registration failed: ${regData.error?.message}</p>`;
          }
        } else {
          resultDiv.innerHTML += `<p class="error">‚ùå No packages available for registration</p>`;
        }
      } catch (error) {
        resultDiv.innerHTML += `<p class="error">‚ùå Registration test failed: ${error.message}</p>`;
      }
    }
    
    function showCountdownExamples() {
      const resultDiv = document.getElementById('examplesResult');
      resultDiv.innerHTML = '<h3>Countdown Examples:</h3>';
      
      const examples = [
        { days: 30, text: 'Sisa 30 hari' },
        { days: 25, text: 'Sisa 25 hari' },
        { days: 7, text: 'Sisa 7 hari' },
        { days: 2, text: 'Sisa 2 hari' },
        { days: 1, text: 'Expires Tomorrow' },
        { days: 0, text: 'Expires Today' },
        { days: -1, text: 'Expired' },
        { days: -5, text: 'Expired' }
      ];
      
      examples.forEach(example => {
        const date = new Date(Date.now() + example.days * 24 * 60 * 60 * 1000);
        const result = calculateCountdown(date.toISOString());
        
        resultDiv.innerHTML += `
          <div class="${example.days < 0 ? 'error' : 'success'}">
            <strong>${example.days} days:</strong> ${result.countdownText}
          </div>
        `;
      });
      
      resultDiv.innerHTML += '<p class="info">These examples show how the countdown will display in the user dashboard.</p>';
    }
    
    // Auto-run countdown calculation test on page load
    window.addEventListener('load', () => {
      console.log('Countdown system test page loaded');
    });
  </script>
</body>
</html>