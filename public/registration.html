<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Register - Rflix</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .register-container {
      width: 100%;
      max-width: 480px;
    }
    
    .register-card {
      background: var(--bg);
      border-radius: var(--radius-lg);
      padding: 3rem 2.5rem;
      box-shadow: var(--shadow-deep);
      border: 1px solid var(--border-color);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .register-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    
    .register-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .register-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .input-wrapper {
      position: relative;
      margin-bottom: 1.5rem;
    }
    
    .input-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1.1rem;
      pointer-events: none;
      z-index: 1;
    }
    
    .input-with-icon {
      padding-left: 50px !important;
    }
    
    .submit-btn {
      width: 100%;
      padding: 15px;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 1rem;
    }
    
    .divider {
      text-align: center;
      margin: 2rem 0;
      position: relative;
    }
    
    .divider::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 1px;
      background: var(--border-color);
    }
    
    .divider span {
      background: var(--bg);
      padding: 0 1rem;
      position: relative;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    
    .login-link {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .login-link a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .login-link a:hover {
      text-shadow: 0 0 10px var(--accent-glow);
    }
    
    .theme-toggle {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 100;
    }

    .btn-icon {
      width: 48px;
      height: 48px;
      padding: 0;
      font-size: 1.25rem;
      border-radius: 50%;
    }
    
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-sm);
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: var(--danger);
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }
    
    .field-label {
      display: block;
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      margin-left: 0.5rem;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .register-card {
        padding: 2rem 1.5rem;
      }
      
      .theme-toggle {
        top: 1rem;
        right: 1rem;
      }
      
      .register-title {
        font-size: 1.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Theme Toggle -->
  <div class="theme-toggle">
    <button class="neu-btn btn-icon" onclick="toggleTheme()" aria-label="Toggle theme">
      ðŸŒ™
    </button>
  </div>

  <div class="register-container">
    <div class="register-card">
      <!-- Header -->
      <div class="register-header">
        <h1 class="register-title">Create Account</h1>
        <p class="register-subtitle">Join Rflix Today</p>
      </div>

      <!-- Error Message -->
      <div id="errorMsg" class="error-message"></div>

      <!-- Form -->
      <form id="registrationForm">
        <!-- Dynamic Fields Container -->
        <div id="dynamicFields">
          <div class="text-center text-muted p-4">Loading form...</div>
        </div>

        <!-- Captcha -->
        <div id="captchaContainer" style="display: flex; justify-content: center; margin: 1.5rem 0;"></div>

        <!-- Submit Button -->
        <button type="submit" class="neu-btn submit-btn primary">
          Register
        </button>
      </form>

      <!-- Divider -->
      <div class="divider">
        <span>or</span>
      </div>

      <!-- Login Link -->
      <div class="login-link">
        Already have an account? <a href="/user">Login Here</a>
      </div>
    </div>
  </div>


  <script>
    // Theme Toggle Logic
    function toggleTheme() {
      const body = document.body;
      const btn = document.querySelector('.theme-toggle button');
      
      body.classList.toggle('light-mode');
      
      if (body.classList.contains('light-mode')) {
        btn.textContent = 'â˜€ï¸';
        btn.setAttribute('aria-label', 'Switch to dark mode');
        localStorage.setItem('theme', 'light');
      } else {
        btn.textContent = 'ðŸŒ™';
        btn.setAttribute('aria-label', 'Switch to light mode');
        localStorage.setItem('theme', 'dark');
      }
    }

    // Initialize theme from localStorage
    (function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const btn = document.querySelector('.theme-toggle button');
      
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        btn.textContent = 'â˜€ï¸';
        btn.setAttribute('aria-label', 'Switch to dark mode');
      } else {
        btn.setAttribute('aria-label', 'Switch to light mode');
      }
    })();

    // Icon mapping for different field types
    const fieldIcons = {
      'email': 'ðŸ“§',
      'password': 'ðŸ”’',
      'text': 'âœï¸',
      'tel': 'ðŸ“±',
      'number': 'ðŸ”¢',
      'username': 'ðŸ‘¤',
      'phone': 'ðŸ“±',
      'address': 'ðŸ '
    };

    function getFieldIcon(field) {
      // Check field name first
      if (fieldIcons[field.name]) return fieldIcons[field.name];
      // Then check field type
      if (fieldIcons[field.type]) return fieldIcons[field.type];
      // Default
      return 'ðŸ“';
    }

    // Fetch and Render Fields
    async function loadFormFields() {
      try {
        const res = await fetch('/api/form-fields');
        const json = await res.json();
        
        if (!json.success) throw new Error(json.error?.message || 'Failed to load form');
        
        const container = document.getElementById('dynamicFields');
        container.innerHTML = '';

        // Sort by sort_order (API uses sort_order, not displayOrder)
        const fields = json.data.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

        fields.forEach(field => {
          const fieldHtml = createFieldHtml(field);
          container.insertAdjacentHTML('beforeend', fieldHtml);
        });

      } catch (error) {
        console.error('Failed to load form fields:', error);
        document.getElementById('dynamicFields').innerHTML = 
          '<div class="text-danger text-center">Failed to load form</div>';
      }
    }

    function createFieldHtml(field) {
      // Map API field names to our usage
      const fieldName = field.field_key || field.name;
      const fieldLabel = field.label;
      const fieldType = field.type;
      const isRequired = field.required || field.isRequired;
      const placeholder = field.placeholder;
      
      const requiredAttr = isRequired ? 'required' : '';
      const icon = getFieldIcon({ name: fieldName, type: fieldType });
      
      if (fieldType === 'select') {
        // Parse options if it's a string
        let options = [];
        if (typeof field.options === 'string') {
          options = field.options.split(',').map(o => o.trim());
        } else if (Array.isArray(field.options)) {
          options = field.options.map(opt => {
            if (typeof opt === 'object') return opt.label || opt.value || opt;
            return opt;
          });
        }
        
        return `
          <div class="input-wrapper">
            ${fieldLabel ? `<label class="field-label">${fieldLabel}${isRequired ? ' *' : ''}</label>` : ''}
            <span class="input-icon">ðŸ“‹</span>
            <select 
              id="${fieldName}" 
              name="${fieldName}" 
              ${requiredAttr}
              class="neu-input input-with-icon"
            >
              <option value="">${placeholder || 'Select ' + fieldLabel}</option>
              ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
          </div>
        `;
      }
      
      if (fieldType === 'textarea') {
        return `
          <div class="input-wrapper">
            ${fieldLabel ? `<label class="field-label">${fieldLabel}${isRequired ? ' *' : ''}</label>` : ''}
            <textarea 
              id="${fieldName}" 
              name="${fieldName}" 
              ${requiredAttr}
              class="neu-input"
              placeholder="${placeholder || fieldLabel}"
              rows="3"
            ></textarea>
          </div>
        `;
      }

      return `
        <div class="input-wrapper">
          ${fieldLabel ? `<label class="field-label">${fieldLabel}${isRequired ? ' *' : ''}</label>` : ''}
          <span class="input-icon">${icon}</span>
          <input 
            type="${fieldType}" 
            id="${fieldName}" 
            name="${fieldName}" 
            ${requiredAttr}
            class="neu-input input-with-icon"
            placeholder="${placeholder || fieldLabel}"
          />
        </div>
      `;
    }

    // Captcha Logic
    async function getCaptchaProvider() {
      try {
        const res = await fetch('/api/config/captcha-provider');
        const data = await res.json();
        return data.data?.provider || 'turnstile';
      } catch {
        return 'turnstile';
      }
    }

    async function renderCaptcha() {
      const provider = await getCaptchaProvider();
      const container = document.getElementById('captchaContainer');
      
      try {
        const res = await fetch('/api/config/captcha-sitekey');
        const data = await res.json();
        const siteKey = data.data?.siteKey;

        if (!siteKey) {
          console.warn('No captcha site key configured');
          return;
        }

        if (provider === 'turnstile' || provider === 'cloudflare') {
          container.innerHTML = `<div class="cf-turnstile" data-sitekey="${siteKey}" data-theme="dark"></div>`;
        } else {
          container.innerHTML = `<div class="g-recaptcha" data-sitekey="${siteKey}" data-theme="dark"></div>`;
        }
      } catch (error) {
        console.error('Failed to render captcha:', error);
      }
    }

    // Form Submit
    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.style.display = 'none';

      // Collect data
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());

      // Client-side validation for password match
      if (data.password && data.confirmPassword && data.password !== data.confirmPassword) {
        errorMsg.textContent = 'Passwords do not match';
        errorMsg.style.display = 'block';
        return;
      }
      
      const provider = await getCaptchaProvider();
      let captchaToken = '';
      
      if (provider === 'turnstile' || provider === 'cloudflare') {
        const turnstileInput = document.querySelector('.cf-turnstile input[name="cf-turnstile-response"]');
        captchaToken = turnstileInput?.value || '';
      } else {
        captchaToken = typeof grecaptcha !== 'undefined' ? grecaptcha.getResponse() : '';
      }

      try {
        const res = await fetch('/api/registration', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            ...data,
            recaptchaToken: captchaToken 
          }),
        });

        const result = await res.json();

        if (res.ok && result.success) {
          alert('Registration successful! Please wait for admin approval.');
          window.location.href = '/user';
        } else {
          errorMsg.textContent = result.error?.message || 'Registration failed';
          errorMsg.style.display = 'block';
          if (provider === 'recaptcha' && typeof grecaptcha !== 'undefined') {
            grecaptcha.reset();
          }
        }
      } catch (error) {
        errorMsg.textContent = 'Network error. Please try again.';
        errorMsg.style.display = 'block';
      }
    });

    // Init
    loadFormFields();
    renderCaptcha();
  </script>
</body>
</html>
