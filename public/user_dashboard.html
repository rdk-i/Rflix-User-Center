<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard - Rflix API</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="theme-toggle">
    <button class="neu-btn btn-icon" onclick="toggleTheme()">üåô</button>
  </div>

  <div style="max-width: 1024px; margin: 0 auto; padding: 2rem;">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1>User Dashboard</h1>
        <p class="text-muted">Manage your subscription and account</p>
      </div>
      <div class="flex items-center gap-4">
        <span id="userEmail" class="text-muted hidden md:block"></span>
        <button onclick="logout()" class="neu-btn neu-btn-sm danger">Logout</button>
      </div>
    </div>

    <!-- Subscription Status -->
    <div class="neu-panel">
      <h3 class="mb-4">Subscription Status</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center">
          <p class="text-muted text-sm uppercase mb-2">Status</p>
          <div id="statusBadge" class="neu-badge inline-block">Loading...</div>
        </div>
        <div class="text-center">
          <p class="text-muted text-sm uppercase mb-2">Expires On</p>
          <p id="expiryDate" class="text-xl font-bold">---</p>
        </div>
        <div class="text-center">
          <p class="text-muted text-sm uppercase mb-2">Plan Type</p>
          <p id="planType" class="text-xl font-bold">---</p>
        </div>
      </div>
    </div>

    <!-- Extend Subscription -->
    <div class="neu-panel">
      <h3 class="mb-4">Extend Subscription</h3>
      <form id="extendForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="neu-input-group">
          <select id="extendDuration" class="neu-select">
            <option value="1">1 Month</option>
            <option value="3">3 Months</option>
            <option value="6">6 Months</option>
            <option value="12">12 Months</option>
          </select>
        </div>
        <div class="neu-input-group">
          <input type="text" id="extendCoupon" class="neu-input" placeholder="Coupon Code (Optional)" />
        </div>
        <button type="submit" class="neu-btn primary" style="margin-top: 0;">Extend Now</button>
      </form>
    </div>

    <!-- Recent Activity -->
    <div class="neu-panel">
      <h3 class="mb-4">Recent Activity</h3>
      <div class="overflow-x-auto">
        <table class="neu-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Action</th>
              <th>Details</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="activityLog">
            <tr>
              <td colspan="4" class="text-center text-muted">Loading activity...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Theme Toggle Logic
    // Theme Toggle Logic
    function toggleTheme() {
      const body = document.body;
      const btn = document.querySelector('.theme-toggle button');
      
      body.classList.toggle('light-mode');
      
      if (body.classList.contains('light-mode')) {
        btn.textContent = '‚òÄÔ∏è';
        localStorage.setItem('theme', 'light');
      } else {
        btn.textContent = 'üåô';
        localStorage.setItem('theme', 'dark');
      }
    }

    // Init Theme
    // Init Theme
    if (localStorage.getItem('theme') === 'light') {
      document.body.classList.add('light-mode');
      document.querySelector('.theme-toggle button').textContent = '‚òÄÔ∏è';
    }

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/user';
    }

    // Load user data
    async function loadUserData() {
      try {
        const res = await fetch('/api/users/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) {
          if (res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/user';
            return;
          }
          throw new Error('Failed to load user data');
        }

        const data = await res.json();
        const user = data.data;

        document.getElementById('userEmail').textContent = user.email;
        
        // Status Badge
        const statusBadge = document.getElementById('statusBadge');
        const subscription = user.subscription;
        
        if (!subscription) {
          statusBadge.textContent = 'No Subscription';
          statusBadge.className = 'neu-badge expired';
          document.getElementById('expiryDate').textContent = '---';
          document.getElementById('planType').textContent = '---';
        } else {
          if (!subscription.isActive) {
            statusBadge.textContent = 'Disabled';
            statusBadge.className = 'neu-badge expired';
          } else if (subscription.isExpired) {
            statusBadge.textContent = 'Expired';
            statusBadge.className = 'neu-badge expired';
          } else {
            statusBadge.textContent = 'Active';
            statusBadge.className = 'neu-badge active';
          }

          // Display countdown text instead of just date
          document.getElementById('expiryDate').textContent = subscription.countdownText;
          document.getElementById('planType').textContent = 'Premium'; // Placeholder - could be enhanced with package name
        }

      } catch (error) {
        console.error(error);
      }
    }

    // Load Activity Log (Mockup for now as endpoint might not exist yet)
    function loadActivityLog() {
      const tbody = document.getElementById('activityLog');
      tbody.innerHTML = `
        <tr>
          <td>${new Date().toLocaleDateString()}</td>
          <td>Login</td>
          <td>Successful login</td>
          <td>127.0.0.1</td>
        </tr>
      `;
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/user';
    }

    // Load data on page load
    loadUserData();
    loadActivityLog();
  </script>
</body>
</html>
